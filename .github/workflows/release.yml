name: Release

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
            ext: .exe

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test ./internal/...

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ github.ref_name }}
          EXT: ${{ matrix.ext }}
        run: |
          mkdir -p dist
          go build -trimpath -ldflags "-s -w -X main.version=${VERSION}" -o "dist/recuerd0-${GOOS}-${GOARCH}${EXT}" ./cmd/recuerd0

      - name: Checksums
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          EXT: ${{ matrix.ext }}
        run: |
          cd dist
          sha256sum "recuerd0-${GOOS}-${GOARCH}${EXT}" > "SHA256SUMS-${GOOS}-${GOARCH}.txt"

      - name: Upload assets to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/recuerd0-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}
            dist/SHA256SUMS-${{ matrix.goos }}-${{ matrix.goarch }}.txt

  build-packages:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            goarch: amd64
            rpm_arch: x86_64
          - arch: arm64
            goarch: arm64
            rpm_arch: aarch64

    steps:
      - uses: actions/checkout@v4

      - name: Install packaging tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Download binary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          curl -sL "https://github.com/maquina-app/recuerd0-cli/releases/download/v${VERSION}/recuerd0-linux-${{ matrix.goarch }}" -o recuerd0
          chmod +x recuerd0

      - name: Build .deb package
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          PKG_ROOT="recuerd0-cli_${VERSION}_${{ matrix.arch }}"

          mkdir -p "${PKG_ROOT}/DEBIAN"
          mkdir -p "${PKG_ROOT}/usr/bin"
          mkdir -p "${PKG_ROOT}/usr/share/doc/recuerd0-cli"

          cp recuerd0 "${PKG_ROOT}/usr/bin/recuerd0"
          cp LICENSE "${PKG_ROOT}/usr/share/doc/recuerd0-cli/copyright"

          cat > "${PKG_ROOT}/DEBIAN/control" << EOF
          Package: recuerd0-cli
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Maintainer: Mario Alberto Chávez Cárdenas <mario@maquina.app>
          Description: CLI for preserving, versioning, and organizing knowledge from AI conversations
           A command-line interface for the Recuerd0 API.
          Homepage: https://github.com/maquina-app/recuerd0-cli
          EOF

          sed -i 's/^          //' "${PKG_ROOT}/DEBIAN/control"

          dpkg-deb --build "${PKG_ROOT}"

      - name: Build .rpm package
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpmbuild/BUILDROOT/recuerd0-cli-${VERSION}-1.${{ matrix.rpm_arch }}/usr/bin
          mkdir -p rpmbuild/BUILDROOT/recuerd0-cli-${VERSION}-1.${{ matrix.rpm_arch }}/usr/share/licenses/recuerd0-cli

          cp recuerd0 rpmbuild/BUILDROOT/recuerd0-cli-${VERSION}-1.${{ matrix.rpm_arch }}/usr/bin/recuerd0
          cp LICENSE rpmbuild/BUILDROOT/recuerd0-cli-${VERSION}-1.${{ matrix.rpm_arch }}/usr/share/licenses/recuerd0-cli/LICENSE

          cat > rpmbuild/SPECS/recuerd0-cli.spec << EOF
          Name:           recuerd0-cli
          Version:        ${VERSION}
          Release:        1
          Summary:        CLI for preserving, versioning, and organizing knowledge from AI conversations
          License:        MIT
          URL:            https://github.com/maquina-app/recuerd0-cli

          %description
          A command-line interface for the Recuerd0 API.

          %files
          %license /usr/share/licenses/recuerd0-cli/LICENSE
          /usr/bin/recuerd0
          EOF

          rpmbuild --define "_topdir $(pwd)/rpmbuild" \
                   --define "_rpmdir $(pwd)/rpmbuild/RPMS" \
                   --target ${{ matrix.rpm_arch }} \
                   -bb rpmbuild/SPECS/recuerd0-cli.spec

          cp rpmbuild/RPMS/${{ matrix.rpm_arch }}/*.rpm .

      - name: Upload packages to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            recuerd0-cli_*_${{ matrix.arch }}.deb
            recuerd0-cli-*.rpm

  homebrew-publish:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    steps:
      - name: Update Homebrew Formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          curl -sL "https://github.com/maquina-app/recuerd0-cli/releases/download/v${VERSION}/SHA256SUMS-darwin-amd64.txt" -o sha256-amd64.txt
          curl -sL "https://github.com/maquina-app/recuerd0-cli/releases/download/v${VERSION}/SHA256SUMS-darwin-arm64.txt" -o sha256-arm64.txt

          SHA256_AMD64=$(cut -d' ' -f1 sha256-amd64.txt)
          SHA256_ARM64=$(cut -d' ' -f1 sha256-arm64.txt)

          cat > recuerd0-cli.rb << 'FORMULA'
          class Recuerd0Cli < Formula
            desc "CLI for preserving, versioning, and organizing knowledge from AI conversations"
            homepage "https://github.com/maquina-app/recuerd0-cli"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/maquina-app/recuerd0-cli/releases/download/v#{version}/recuerd0-darwin-arm64"
                sha256 "SHA256_ARM64_PLACEHOLDER"
              else
                url "https://github.com/maquina-app/recuerd0-cli/releases/download/v#{version}/recuerd0-darwin-amd64"
                sha256 "SHA256_AMD64_PLACEHOLDER"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/maquina-app/recuerd0-cli/releases/download/v#{version}/recuerd0-linux-arm64"
              else
                url "https://github.com/maquina-app/recuerd0-cli/releases/download/v#{version}/recuerd0-linux-amd64"
              end
            end

            def install
              binary_name = Dir["recuerd0-*"].first
              bin.install binary_name => "recuerd0"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/recuerd0 version")
            end
          end
          FORMULA

          sed -i 's/^          //' recuerd0-cli.rb
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/" recuerd0-cli.rb
          sed -i "s/SHA256_ARM64_PLACEHOLDER/${SHA256_ARM64}/" recuerd0-cli.rb
          sed -i "s/SHA256_AMD64_PLACEHOLDER/${SHA256_AMD64}/" recuerd0-cli.rb

          git clone https://x-access-token:${GH_TOKEN}@github.com/maquina-app/homebrew-tap.git
          cd homebrew-tap
          mkdir -p Formula
          cp ../recuerd0-cli.rb Formula/recuerd0-cli.rb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/recuerd0-cli.rb
          git commit -m "Update recuerd0-cli to ${VERSION}"
          git push
